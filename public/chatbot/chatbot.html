<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style id="theme-styles">
      :root {
        --primary-color: var(--primary, #007aff);
        --primary-light: color-mix(in srgb, var(--primary-color) 15%, white);
        --primary-lighter: color-mix(in srgb, var(--primary-color) 85%, white);
        --primary-dark: color-mix(in srgb, var(--primary-color) 20%, black);
        --secondary-color: var(--secondary, #f2f2f7);
        --background-color: var(--background, #ffffff);
        --text-color: var(--text, #000000);
        --border-color: #e1e2e5;
        --hover-color: color-mix(in srgb, var(--primary-color) 10%, white);
        --shadow-color: rgba(0, 0, 0, 0.1);
        --input-border: #e0e0e0;
      }
    </style>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Roboto", sans-serif !important;
      }
      body {
        background-color: var(--background-color);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: var(--text-color);
      }
      .chat-container {
        width: 400px;
        height: 540px;
        background: var(--background-color);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        background: var(--primary-color);
        color: white;
        padding: 10px 16px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
      }
      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .header-logo {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }
      .header-info {
        display: flex;
        flex-direction: column;
        gap: 1px;
      }
      .org-details {
        display: flex;
        align-items: center;
      }
      .header-org-name {
        font-size: 14px;
        font-weight: 600;
        letter-spacing: -0.2px;
        color: #000000;
      }
      .assistant-label {
        font-size: 11px;
        font-weight: 400;
        opacity: 0.85;
        color: #000000;
      }
      .chat-messages {
        flex: 1;
        padding: 16px 12px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background-color: var(--secondary-color);
        scroll-behavior: smooth;
      }
      .message-container {
        display: flex;
        flex-direction: column;
        max-width: 82%;
        gap: 2px;
      }
      .message-header {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 10px;
        font-weight: 500;
        color: #64748b;
        margin-bottom: 3px;
      }
      .message-time {
        font-size: 9px;
        color: #64748b;
        margin-top: 3px;
      }
      .user-container {
        align-self: flex-end;
      }
      .user-icon {
        font-size: 12px;
        margin-right: 2px;
      }
      .bot-logo {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        object-fit: cover;
      }
      .message {
        padding: 10px 14px;
        border-radius: 14px;
        word-wrap: break-word;
        font-size: 12px;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .user {
        align-self: flex-end;
        background-color: var(--primary-lighter);
        color: rgba(0, 0, 0, 0.87);
        border-top-right-radius: 4px;
        opacity: 1;
        background-color: #d1e3fa;
      }
      .bot {
        align-self: flex-start;
        background-color: white;
        color: rgba(0, 0, 0, 0.87);
        border-top-left-radius: 2px;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .user .message-time {
        text-align: right;
      }
      .chat-input {
        padding: 14px 16px;
        background: var(--background-color);
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chat-input input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--input-border);
        border-radius: 24px;
        font-size: 14px;
        transition: all 0.2s ease;
        background-color: white;
        box-shadow: 0 0 0 0 var(--primary-color);
      }
      .chat-input input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px
          color-mix(in srgb, var(--primary-color) 20%, transparent);
      }
      .chat-input input:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 1px
          color-mix(in srgb, var(--primary-color) 15%, transparent);
      }
      .chat-input input::placeholder {
        color: color-mix(in srgb, var(--text-color) 50%, transparent);
      }
      .chat-input button {
        padding: 10px 18px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 20px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 4px;
        letter-spacing: 0.2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .chat-input button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      .project-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
      }
      .project-card {
        display: flex;
        align-items: center;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        padding: 12px;
        background-color: var(--background-color);
        cursor: pointer;
        transition: all 0.25s ease;
        margin-bottom: 8px;
      }
      .project-card:hover {
        background-color: var(--primary-lighter);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      .project-card img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
        margin-right: 12px;
      }
      .project-info {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .project-title {
        font-weight: 600;
        margin-bottom: 4px;
        font-size: 14px;
        color: rgba(0, 0, 0, 0.87);
      }
      .project-address,
      .project-description {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.6);
        line-height: 1.5;
      }
      .contact-form-container {
        max-width: 340px;
      }
      .contact-form-title {
        font-size: 15px;
        font-weight: 600;
        letter-spacing: -0.3px;
        color: rgba(0, 0, 0, 0.87);
        margin-bottom: 6px;
      }
      .contact-form-subtitle {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.6);
        line-height: 1.5;
        margin-bottom: 16px;
      }
      .contact-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .form-group {
        position: relative;
      }
      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
        transition: all 0.2s ease;
        background-color: #f8fafc;
      }
      .form-group input:focus {
        border-color: var(--primary-color);
        background-color: white;
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
        outline: none;
      }
      .form-group input::placeholder {
        color: #94a3b8;
        font-size: 12px;
      }
      .contact-submit-btn {
        background: var(--primary-color) !important;
        color: white;
        border: none;
        border-radius: 8px !important;
        padding: 8px 16px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        cursor: pointer;
        transition: all 0.2s ease;
        letter-spacing: 0.2px !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
        margin-top: 4px;
      }
      .contact-submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.2);
      }
      .contact-submit-btn:active {
        transform: translateY(0);
      }
      .mt-4 {
        margin-top: 8px !important;
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 4px !important;
        width: 100% !important;
      }
      [class*="flex-1"].px-4 {
        padding: 4px 8px !important;
        font-size: 11px !important;
        height: 28px !important;
        background: white !important;
      }
      [class*="flex-1"].px-4 .text-base {
        font-size: 14px !important;
        margin-right: 2px;
      }
      [class*="flex-1"].px-4:hover {
        transform: translateY(-1px);
        transition: all 0.2s ease;
      }
      /* Custom scrollbar styles */
      .chat-messages::-webkit-scrollbar {
        width: 4px !important;
        height: 4px !important;
      }
      .chat-messages::-webkit-scrollbar-track {
        background: transparent !important;
        border-radius: 10px !important;
      }
      .chat-messages::-webkit-scrollbar-thumb {
        background: color-mix(
          in srgb,
          var(--primary-color) 70%,
          transparent
        ) !important;
        border-radius: 10px !important;
        transition: all 0.2s ease !important;
      }
      .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--primary-color) !important;
      }
      .chat-messages::-webkit-scrollbar-corner {
        background: transparent !important;
      }
      .chat-messages {
        scrollbar-width: thin !important;
        scrollbar-color: var(--primary-color) transparent !important;
      }
      div[style*="overflow-x: auto"]::-webkit-scrollbar {
        width: 4px !important;
        height: 4px !important;
      }
      div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
        background: transparent !important;
        border-radius: 10px !important;
      }
      div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
        background: color-mix(
          in srgb,
          var(--primary-color) 70%,
          transparent
        ) !important;
        border-radius: 10px !important;
      }
      div[style*="overflow-x: auto"]::-webkit-scrollbar-corner {
        background: transparent !important;
      }
      .close-button {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: black;
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.2s ease;
        padding: 0;
      }
      .close-button:hover {
        opacity: 1;
        transform: scale(1.1);
      }
      .close-button svg {
        width: 20px;
        height: 20px;
      }
      /* Add these styles for phone input */
      .iti {
        width: 100% !important;
        display: block !important;
      }
      .iti__flag-container {
        z-index: 2 !important;
      }
      .iti__tel-input {
        width: 100% !important;
        padding: 6px 10px 6px 50px !important;

        border: 1px solid #e2e8f0 !important;
        border-radius: 6px !important;
        font-size: 13px !important;
        line-height: 1.4 !important;
        transition: all 0.2s ease !important;
        background-color: #f8fafc !important;
      }
      .iti__tel-input:focus {
        border-color: var(--primary-color) !important;
        background-color: white !important;
        box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1) !important;
        outline: none !important;
      }
      .iti__tel-input::placeholder {
        color: #94a3b8 !important;
        font-size: 12px !important;
      }
      .carousel-container {
        position: relative;
        overflow: hidden;
      }
      .carousel-track {
        display: flex;
        transition: transform 0.3s ease;
      }
      .carousel-slide {
        flex: 0 0 100%;
        min-width: 100%;
      }
      .carousel-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .carousel-controls button {
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--button-border-color);
        padding: 5px 10px;
        border-radius: 6px;
        cursor: pointer;
        margin: 0 8px;
        transition: all 0.2s ease;
        font-weight: 500;
      }
      .carousel-controls button:hover {
        background-color: color-mix(in srgb, var(--primary-color) 10%, white);
      }
      /* Add these styles in the existing <style> section */
      .project-details-container {
        background: var(--background-color);
        border-radius: 10px;
        padding: 20px;
        margin: 8px 0;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .project-header {
        margin-bottom: 16px;
      }

      .project-header h3 {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 8px;
        color: rgba(0, 0, 0, 0.87);
        letter-spacing: -0.3px;
      }

      .project-header p {
        font-size: 12px;
        line-height: 1.6;
        color: rgba(0, 0, 0, 0.7);
        margin-bottom: 14px;
      }

      .project-info-grid {
        display: grid;
        gap: 12px;
        margin-bottom: 20px;
      }

      .info-item {
        display: flex;
        gap: 8px;
        font-size: 12px;
      }

      .info-item .label {
        font-weight: 500;
        color: rgba(0, 0, 0, 0.7);
      }

      .project-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .action-btn {
        flex: 1;
        padding: 8px 14px;
        background: white;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        letter-spacing: 0.2px;
      }

      .action-btn:hover {
        background-color: color-mix(in srgb, var(--primary-color) 10%, white);
        transform: translateY(-1px);
      }

      .project-image {
        width: 120px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "var(--primary-color)",
              secondary: "var(--secondary-color)",
              background: "var(--background-color)",
              text: "var(--text-color)",
              border: "var(--border-color)",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="header-content">
          <div class="header-left">
            <img src="" alt="Org Logo" class="header-logo" id="orgLogo" />
            <div class="header-info">
              <div class="org-details">
                <span class="header-org-name" id="orgName"></span>
              </div>
              <span class="assistant-label">Live automated assistant</span>
            </div>
          </div>
          <button
            class="close-button"
            onclick="window.parent.document.querySelector('.chatbot-widget-iframe').style.display='none'"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"
                fill="currentColor"
              />
            </svg>
          </button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input
          type="text"
          id="chatInput"
          placeholder="Ask about our properties..."
          onkeypress="if(event.key === 'Enter') sendMessage()"
          style="border: 1px solid var(--button-border-color)"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      // Constants
      const keywordMappings = {
        greetings: [
          "hi",
          "hello",
          "hey",
          "good morning",
          "good afternoon",
          "good evening",
          "howdy",
          "hola",
        ],
        pricing: ["pricing", "price", "cost", "rate", "value", "amount"],
        projects: [
          "project",
          "projects",
          "property",
          "properties",
          "home",
          "house",
          "apartment",
          "flat",
          "villa",
        ],
        blocks: [
          "block",
          "blocks",
          "tower",
          "towers",
          "building",
          "buildings",
          "structure",
        ],
        contact: ["contact", "phone", "email", "reach", "connect", "call"],
        amenities: [
          "amenity",
          "amenities",
          "facility",
          "facilities",
          "feature",
          "features",
        ],
        location: [
          "location",
          "address",
          "where",
          "place",
          "situated",
          "located",
        ],
        nearby: [
          "nearby",
          "near",
          "around",
          "proximity",
          "proximities",
          "surrounding",
          "neighbourhood",
          "neighborhood",
        ],
        interior: ["interior", "interior features", "interior facilities"],
        exterior: ["exterior", "exterior features", "exterior facilities"],
        developerProfile: [
          "developer",
          "developer profile",
          "developer details",
        ],
        upcomingProjects: ["upcoming", "upcoming projects", "future projects"],
        pastProjects: ["past", "past projects", "completed projects"],
        brochure: [
          "brochure",
          "catalogue",
          "catalog",
          "document",
          "documentation",
          "pdf",
          "download",
          "information kit",
        ],
      };

      const amenityIcons = {
        "Water Supply": "💧",
        Parking: "🅿️",
        Security: "🔒",
        "Power Backup": "⚡",
        Wifi: "📶",
        Gym: "💪",
        "Air conditioner": "❄️",
        "Swimming Pool": "🏊‍♂️",
        "Gas Station": "⛽",
        Park: "🌳",
        "Fire Safety": "🧯",
        Elevator: "🛗",
        "Play Area": "🎮",
      };

      // Utility Functions
      function detectKeywords(text) {
        const normalizedText = text.toLowerCase();
        const words = normalizedText.split(/\s+/);
        const matches = {};
        Object.entries(keywordMappings).forEach(([category, keywords]) => {
          if (
            keywords.some((keyword) =>
              words.some((word) => word.includes(keyword))
            )
          ) {
            matches[category] = true;
          }
        });
        return matches;
      }

      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      let messages = [];
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const chatbotId = new URLSearchParams(window.location.search).get(
        "chatbotid"
      );
      let issueTemplateId;
      let organizationProfileId = null;
      let organizationLocations = [];

      const serverUrl = decodeURIComponent(
        new URLSearchParams(window.location.search).get("serverUrl")
      );

      let formInputId = 0;
      let phoneInputInstances = [];

      // Global variable to keep track of the rendered messages count
      let lastRenderedIndex = 0;

      // Global variable to store the user's selected project context
      let currentProject = null;

      let projectsData = [];

      const carouselState = {
        upcoming: { currentIndex: 0, total: 0 },
        past: { currentIndex: 0, total: 0 },
      };

      function initializeCarousel(type, totalSlides) {
        const carousel = document.getElementById(`${type}-carousel`);
        const counter = document.getElementById(`${type}-counter`);

        if (!carousel || !counter) return;

        carouselState[type] = {
          currentIndex: 0,
          total: totalSlides,
        };

        updateCarouselDisplay(type);
      }

      function moveCarousel(type, direction) {
        const state = carouselState[type];
        if (!state || state.total === 0) return; // Add check for total = 0

        if (direction === "next") {
          state.currentIndex = (state.currentIndex + 1) % state.total;
        } else {
          state.currentIndex =
            (state.currentIndex - 1 + state.total) % state.total;
        }

        updateCarouselDisplay(type);
      }

      function updateCarouselDisplay(type) {
        const state = carouselState[type];
        const track = document.querySelector(
          `#${type}-carousel .carousel-track`
        );
        const counter = document.getElementById(`${type}-counter`);

        if (!track || !counter || !state || state.total === 0) return;

        // Update the transform to move to the current slide
        track.style.transform = `translateX(-${state.currentIndex * 100}%)`;

        // Update the counter display with validation
        const currentIndex = state.currentIndex + 1;
        const total = state.total;
        counter.textContent = `${currentIndex}/${total}`;
      }

      // Add initialization calls after content is added
      function initializeCarousels() {
        if (chatbotSettings.upcomingProjects?.length > 0) {
          initializeCarousel(
            "upcoming",
            chatbotSettings.upcomingProjects.length
          );
        }
        if (chatbotSettings.pastProjects?.length > 0) {
          initializeCarousel("past", chatbotSettings.pastProjects.length);
        }
      }

      // Call this after the content is added to the DOM
      setTimeout(initializeCarousels, 100);

      function initialRenderMessages() {
        const messagesContainer = document.querySelector(".chat-messages");
        const orgLogo = document.getElementById("orgLogo").src;
        const htmlContent = messages
          .map((message) => {
            const time = new Date().toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            const isUser = message.sender === "user";
            return `
              <div class="message-container ${isUser ? "user-container" : ""}">
                <div class="message-header">
                  ${
                    isUser
                      ? '<span class="user-icon">🙍‍♂️</span>'
                      : `<img src="${orgLogo}" alt="Bot" class="bot-logo" />`
                  }
                  <span class="message-time">${time}</span>
                </div>
                <div class="message ${message.sender}">
                  ${message.html || message.text}
                </div>
              </div>
            `;
          })
          .join("");
        messagesContainer.innerHTML = htmlContent;
        lastRenderedIndex = messages.length;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // This function appends only the new messages to the chat
      function appendNewMessages() {
        const messagesContainer = document.querySelector(".chat-messages");
        const orgLogo = document.getElementById("orgLogo").src;
        // Loop through messages that haven't been rendered yet
        for (let i = lastRenderedIndex; i < messages.length; i++) {
          const message = messages[i];
          const time = new Date().toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });
          const isUser = message.sender === "user";
          const newMessageHTML = `
            <div class="message-container ${isUser ? "user-container" : ""}">
              <div class="message-header">
                ${
                  isUser
                    ? '<span class="user-icon">🙍‍♂️</span>'
                    : `<img src="${orgLogo}" alt="Bot" class="bot-logo" />`
                }
                <span class="message-time">${time}</span>
              </div>
              <div class="message ${message.sender}">
                ${message.html || message.text}
              </div>
            </div>
          `;
          // Append the new message without affecting the already rendered messages.
          messagesContainer.insertAdjacentHTML("beforeend", newMessageHTML);
        }
        lastRenderedIndex = messages.length;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      const getChatbotSettings = async () => {
        try {
          if (!chatbotId || !serverUrl) {
            throw new Error("Missing required parameters");
          }

          const chatbotSettingsRes = await fetch(
            `${serverUrl}api/chatbot/get`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ chatbotSettingsId: chatbotId }),
            }
          );

          if (!chatbotSettingsRes.ok) {
            throw new Error("Failed to fetch chatbot settings");
          }

          const { chatbotSettings } = await chatbotSettingsRes.json();

          console.log("Chatbot Settings: ", chatbotSettings);

          const themeStyles = document.getElementById("theme-styles");

          function getFirstColorFromGradient(colorValue) {
            if (colorValue.includes("linear-gradient")) {
              const match = colorValue.match(/linear-gradient\([^,]+,([^,]+)/);
              return match ? match[1].trim() : colorValue;
            }
            return colorValue;
          }

          let borderColor = getFirstColorFromGradient(
            chatbotSettings.colorTheme.primary
          );
          themeStyles.textContent = `
          :root {
              --primary-color: ${chatbotSettings.colorTheme.primary};
              --secondary-color: ${chatbotSettings.colorTheme.secondary};
              --background-color: ${chatbotSettings.colorTheme.background};
              --text-color: ${chatbotSettings.colorTheme.text};
              --button-border-color: ${borderColor};
            }
          `;
          const chatbotType = chatbotSettings.parentModelName;

          issueTemplateId = chatbotSettings.issueTemplate;

          let organization = chatbotSettings.organization;
          organizationProfileId = organization.profile;
          organizationLocations = organization.locations;

          const orgLogo = document.getElementById("orgLogo");
          const orgName = document.getElementById("orgName");
          orgLogo.src = organization.displayPicture.url;
          orgName.textContent = organization.displayName;

          projectsData = chatbotSettings.projects || [];

          function renderProjects(projects) {
            let html = `
              <div style="margin-top: 8px;">
                <div style="background: white; border-radius: 8px; max-width: 100%; position: relative;">
                  <div style="font-weight: 600; margin: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <span>Our Projects</span>
                  </div>
                  
                  <!-- Position controls as an overlay that extends outside -->
                  <div class="carousel-controls" style="position: absolute; top: 50%; transform: translateY(-50%); left: -20px; right: -20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 2;">
                    <button onclick="moveCarousel('projects', 'prev')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">←</button>
                    <button onclick="moveCarousel('projects', 'next')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">→</button>
                  </div>

                  <div style="text-align: center; margin-bottom: 8px;">
                    <span id="projects-counter">1/${projects.length}</span>
                  </div>
                  
                  <div class="carousel-container" id="projects-carousel" style="overflow: hidden; max-width: 100%; margin: 0 auto;">
                    <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: 100%;">
                      ${projects
                        .map(
                          (project) => `
                        <div class="carousel-slide" style="flex: 0 0 100%; min-width: 100%; width: 100%;">
                          ${
                            project.displayPicture
                              ? `<div style="margin-bottom: 8px;">
                              <img src="${project.displayPicture.url}"
                                   alt="${project.displayName}"
                                   style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px;"
                              />
                            </div>`
                              : ""
                          }
                          <div style="font-weight: 600; margin-bottom: 8px;">${
                            project.displayName
                          }</div>
                          ${
                            project.description
                              ? `<div style="margin-bottom: 8px; font-size: 14px;">${project.description}</div>`
                              : ""
                          }
                          ${
                            project.address?.city
                              ? `<div style="font-size: 12px; color: var(--text-color);">
                              <div><strong>Location:</strong> ${project.address.city}</div>
                            </div>`
                              : ""
                          }
                          <div style="margin-top: 12px;">
                            <button
                              onclick="selectProject('${
                                project.projectIdCode
                              }')"
                              style="width: auto; background: white; border: 1px solid var(--button-border-color); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;"
                            >
                              Show Details
                            </button>
                          </div>
                        </div>
                      `
                        )
                        .join("")}
                    </div>
                  </div>
                </div>
              </div>
            `;
            return html;
          }

          const conversationFlow = {
            unknown: {
              message:
                "I'm sorry, I didn't understand that. You can ask me about our projects or type 'projects' to see the available options.",
              next: () => "start",
            },
            end: {
              message:
                "Thank you for chatting with us! If you have more questions about our projects, feel free to ask.",
              next: () => "start",
            },
          };

          let currentState = "start";

          window.selectProject = function (projectId) {
            const project = projectsData.find(
              (p) => p.projectIdCode === projectId
            );
            if (project) {
              currentProject = project;
              messages.push({
                sender: "bot",
                html: `
                  <div style="margin-top: 8px;">
                    <div style="background: white; border-radius: 8px;">
                      ${
                        project.docs &&
                        project.docs.some(
                          (doc) => doc.files && doc.files.length > 0
                        )
                          ? `
                          <div style="margin-bottom: 16px;">
                            <div style="font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                              <div class="carousel-controls">
                                <button onclick="moveCarousel('project-images', 'prev')" style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--button-border-color); cursor: pointer; margin-right: 8px;">←</button>
                                <span id="project-images-counter">1/${project.docs.reduce(
                                  (count, doc) =>
                                    count + (doc.files ? doc.files.length : 0),
                                  0
                                )}</span>
                                <button onclick="moveCarousel('project-images', 'next')" style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--button-border-color); cursor: pointer; margin-left: 8px;">→</button>
                              </div>
                            </div>
                            <div class="carousel-container" id="project-images-carousel" style="overflow: hidden; width: 100%;">
                              <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: 100%;">
                                ${project.docs
                                  .filter(
                                    (doc) => doc.files && doc.files.length > 0
                                  )
                                  .map((doc) =>
                                    doc.files
                                      .map(
                                        (file) => `
                                      <div class="carousel-slide" style="flex: 0 0 100%; min-width: 100%; width: 100%; padding: 0 8px;">
                                        <img src="${file.url}"
                                             alt="${project.displayName}"
                                             style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px;"
                                        />
                                        ${
                                          doc.title
                                            ? `<div style="margin-top: 8px; font-size: 14px; font-weight: 500;">${doc.title}</div>`
                                            : ""
                                        }
                                        ${
                                          doc.description
                                            ? `<div style="font-size: 12px; color: var(--text-color);">${doc.description}</div>`
                                            : ""
                                        }
                                      </div>
                                    `
                                      )
                                      .join("")
                                  )
                                  .join("")}
                              </div>
                            </div>
                          </div>`
                          : project.displayPicture
                          ? `<div style="margin-bottom: 16px;">
                              <img src="${project.displayPicture.url}"
                                   alt="${project.displayName}"
                                   style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px;"
                              />
                            </div>`
                          : ""
                      }
                      <div style="font-weight: 600; margin-bottom: 8px;">${
                        project.displayName
                      }</div>
                      ${
                        project.description
                          ? `<div style="margin-bottom: 12px; font-size: 14px;">${project.description}</div>`
                          : ""
                      }
                      <div class="mt-4">
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'pricing')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">₹</span>Pricing
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'contact')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">☎️</span>Contact
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'location')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">📍</span>Location
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'possession')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">📅</span>Possession
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'amenities')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">🏠</span>Amenities
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'nearby')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">🏘️</span>Nearby
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'interior')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">🏠</span>Interior
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'exterior')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">🏗️</span>Exterior
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'developer')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">👷</span>Developer
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'siteVisit')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">📅</span>Site Visit
                        </button>
                        <button onclick="handleProjectAction('${
                          project.projectIdCode
                        }', 'brochure')" class="flex-1 px-4 py-2 rounded-lg cursor-pointer font-medium flex items-center justify-center gap-2 hover:opacity-90 transition-all" style="border: 1px solid var(--button-border-color);">
                          <span class="text-base">📄</span>Brochure
                        </button>
                      </div>
                    </div>
                  </div>
                `,
              });

              // Initialize carousel if images exist
              if (
                project.docs &&
                project.docs.some((doc) => doc.files && doc.files.length > 0)
              ) {
                setTimeout(() => {
                  initializeCarousel(
                    "project-images",
                    project.docs.reduce(
                      (count, doc) =>
                        count + (doc.files ? doc.files.length : 0),
                      0
                    )
                  );
                }, 0);
              }
              appendNewMessages();
            }
          };

          // Helper function to prepend the project name in bold
          function formatProjectResponse(project, detailsContent) {
            return `<strong>${project.displayName}:</strong><br>${detailsContent}`;
          }

          window.handleProjectAction = function (projectId, action) {
            let project;
            if (projectId) {
              project = projectsData.find((p) => p.projectIdCode === projectId);
              if (!project) return;
            }

            if (action === "pricing" && project) {
              const pricingDetailsContent = `
                Pricing Details<br>
                <div style="margin-top: 8px;">
                  <div style="background: white; padding: 12px; border-radius: 8px;">
                    ${
                      project.pricing && project.pricing.length > 0
                        ? `
                      <div style="margin-top: 12px;">
                        <strong>Additional Pricing Details:</strong>
                        <div style="margin-top: 8px;">
                          ${project.pricing
                            .map(
                              (price) => `
                              <div style="margin-bottom: 4px; display: flex; justify-content: space-between;">
                                <span>${price.title}:</span>
                                <span>₹${numberWithCommas(price.value)}</span>
                              </div>`
                            )
                            .join("")}
                        </div>
                      </div>
                      `
                        : "Pricing information is not available."
                    }
                  </div>
                </div>
              `;
              messages.push({
                sender: "bot",
                html: formatProjectResponse(project, pricingDetailsContent),
              });
              appendNewMessages();
            } else if (action === "upcomingProjects") {
              if (
                chatbotSettings.upcomingProjects &&
                chatbotSettings.upcomingProjects.length > 0
              ) {
                const upcomingProjectsContent = `
                  <div>
                    <div style="background: white; border-radius: 8px; max-width: 100%; position: relative;">
                      <div style="font-weight: 600; margin: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 15px; letter-spacing: -0.2px;">Upcoming Projects</span>
                        </div>
                      
                      <!-- Position controls as an overlay that extends outside -->
                      <div class="carousel-controls" style="position: absolute; top: 50%; transform: translateY(-50%); left: -20px; right: -20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 2;">
                        <button onclick="moveCarousel('upcoming', 'prev')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">←</button>
                        <button onclick="moveCarousel('upcoming', 'next')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">→</button>
                      </div>

                      <div style="text-align: center; margin-bottom: 8px;">
                        <span id="upcoming-counter">1/${
                          chatbotSettings.upcomingProjects.length
                        }</span>
                        </div>
                      
                      <div class="carousel-container" id="upcoming-carousel" style="overflow: hidden; max-width: 100%; margin: 0 auto;">
                        <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: 100%;">
                          ${chatbotSettings.upcomingProjects
                            .map(
                              (projectExp) => `
                            <div class="carousel-slide" style="flex: 0 0 100%; min-width: 100%; width: 100%; box-sizing: border-box; padding: 0 16px 16px;">
                              ${
                                projectExp.project?.displayPicture
                                  ? `<div style="margin-bottom: 12px;">
                                      <img src="${projectExp.project.displayPicture.url}"
                                           alt="${projectExp.project.displayName}"
                                           style="width: 100%; height: 160px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);"
                                      />
                                    </div>`
                                  : ""
                              }
                              <h3 style="font-weight: 600; margin-bottom: 8px; word-wrap: break-word; font-size: 15px; letter-spacing: -0.3px; line-height: 1.3;">${
                                projectExp.project?.displayName ||
                                "Unnamed Project"
                              }</h3>

                              ${
                                projectExp.project?.description
                                  ? `<p style="margin-bottom: 12px; font-size: 12px; line-height: 1.4; word-wrap: break-word; color: rgba(0, 0, 0, 0.7);">${projectExp.project.description}</p>`
                                  : ""
                              }

                              <div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; margin-bottom: 14px; font-size: 11px; line-height: 1.4;">
                                ${
                                  projectExp.project?.address
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Location:</div>
                                      <div>${
                                        projectExp.project.address.city || ""
                                      }${
                                        projectExp.project.address.state
                                          ? `, ${projectExp.project.address.state}`
                                          : ""
                                      }${
                                        projectExp.project.address.fullAddress
                                          ? `<div style="margin-top: 2px; font-size: 12px; color: rgba(0, 0, 0, 0.6);">${projectExp.project.address.fullAddress}</div>`
                                          : ""
                                      }
                                      </div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.projectType
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Type:</div>
                                      <div>${projectExp.project.projectType}</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.startDate
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Start Date:</div>
                                      <div>${new Date(
                                        projectExp.project.startDate
                                      ).toLocaleDateString("en-US", {
                                        year: "numeric",
                                        month: "short",
                                        day: "numeric",
                                      })}</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.projectSize
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Project Size:</div>
                                      <div>${projectExp.project.projectSize}</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.area
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Area:</div>
                                      <div>${projectExp.project.area} sq ft</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.budget
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Budget:</div>
                                      <div>₹${numberWithCommas(
                                        projectExp.project.budget
                                      )}</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.email
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Email:</div>
                                      <div>${projectExp.project.email}</div>`
                                    : ""
                                }

                                ${
                                  projectExp.project?.phone
                                    ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Phone:</div>
                                      <div>${projectExp.project.phone}</div>`
                                    : ""
                                }
                              </div>

                              <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px;">
                                ${
                                  projectExp.project?.brochure
                                    ? `<a href="${projectExp.project.brochure.url}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                        <span style="margin-right: 6px; font-size: 12px;">📄</span> Download Brochure
                                      </a>`
                                    : ""
                                }
                                ${
                                  projectExp.project?.siteLink
                                    ? `<a href="${projectExp.project.siteLink}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                        <span style="margin-right: 6px; font-size: 12px;">🌐</span> Visit Website
                                      </a>`
                                    : ""
                                }
                                ${
                                  projectExp.project?.mediaLink
                                    ? `<a href="${projectExp.project.mediaLink}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                        <span style="margin-right: 6px; font-size: 12px;">🎬</span> View Media
                                      </a>`
                                    : ""
                                }
                              </div>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
                messages.push({
                  sender: "bot",
                  html: upcomingProjectsContent,
                });
                // Initialize carousel after content is added
                setTimeout(() => {
                  initializeCarousel(
                    "upcoming",
                    chatbotSettings.upcomingProjects.length
                  );
                }, 0);
              } else {
                messages.push({
                  sender: "bot",
                  text: "No upcoming projects available at the moment.",
                });
              }
              appendNewMessages();
            } else if (action === "pastProjects") {
              if (
                chatbotSettings.pastProjects &&
                chatbotSettings.pastProjects.length > 0
              ) {
                const pastProjectsContent = `
                  <div>
                    <div style="background: white; border-radius: 8px; max-width: 300px; position: relative;">
                      <div style="font-weight: 600; margin: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 15px; letter-spacing: -0.2px;">Past Projects</span>
                      </div>
                      
                      <!-- Position controls as an overlay that extends outside -->
                      <div class="carousel-controls" style="position: absolute; top: 50%; transform: translateY(-50%); left: -20px; right: -20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 2;">
                        <button onclick="moveCarousel('past', 'prev')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">←</button>
                        <button onclick="moveCarousel('past', 'next')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">→</button>
                      </div>
                      
                      <div style="text-align: center; margin-bottom: 8px;">
                        <span id="past-counter">1/${
                          chatbotSettings.pastProjects.length
                        }</span>
                      </div>
                      
                      <div class="carousel-container" id="past-carousel" style="overflow: hidden; max-width: 300px; margin: 0 auto;">
                        <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: ${
                          chatbotSettings.pastProjects.length * 300
                        }px;">
                          ${chatbotSettings.pastProjects
                            .map(
                              (project, index) => `
                            <div class="carousel-item" style="flex: 0 0 300px; max-width: 300px; padding: 0 12px;">
                              <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                ${
                                  project.project.displayPicture
                                    ? `<img src="${project.project.displayPicture.url}" alt="${project.project.displayName}" style="width: 100%; height: 150px; object-fit: cover;">`
                                    : ""
                                }
                                <div style="padding: 12px;">
                                  <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">${
                                    project.project.displayName
                                  }</div>
                                  <div style="color: var(--text-color-secondary); font-size: 12px; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${
                                    project.project.description
                                  }</div>
                                  <div style="margin-bottom: 8px;">
                                    <div style="color: var(--text-color-secondary); font-size: 12px;">Location:</div>
                                    <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${
                                      project.project.address.city
                                    }, ${project.project.address.state}</div>
                          </div>
                                  <div style="margin-bottom: 8px;">
                                    <div style="color: var(--text-color-secondary); font-size: 12px;">Timeline:</div>
                                    <div style="font-size: 12px;">${
                                      project.startMonth
                                    } ${project.startYear} - ${
                                project.isCurrentlyWorking
                                  ? "Present"
                                  : `${project.endMonth} ${project.endYear}`
                              }</div>
                                  </div>
                                  ${
                                    project.project.amenities &&
                                    project.project.amenities.length > 0
                                      ? `
                                    <div style="margin-bottom: 8px;">
                                      <div style="color: var(--text-color-secondary); font-size: 12px;">Amenities:</div>
                                      <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${project.project.amenities.join(
                                        ", "
                                      )}</div>
                                    </div>`
                                      : ""
                                  }
                                  <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    ${
                                      project.project.siteLink
                                        ? `<a href="${project.project.siteLink}" target="_blank" style="flex: 1; padding: 6px 12px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-size: 12px; text-align: center;">Visit Website</a>`
                                        : ""
                                    }
                                    ${
                                      project.project.mediaLink
                                        ? `<a href="${project.project.mediaLink}" target="_blank" style="flex: 1; padding: 6px 12px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-size: 12px; text-align: center;">View Media</a>`
                                        : ""
                                    }
                                  </div>
                                </div>
                              </div>
                            </div>
                          `
                            )
                            .join("")}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                messages.push({
                  sender: "bot",
                  html: pastProjectsContent,
                });

                setTimeout(() => {
                  initializeCarousel(
                    "past",
                    chatbotSettings.pastProjects.length
                  );
                }, 0);
              } else {
                messages.push({
                  sender: "bot",
                  text: "No past projects available at the moment.",
                });
              }
              appendNewMessages();
            } else if (projectId) {
              if (action === "contact") {
                const contactDetailsContent = `
              Contact Information<br>
              <div style="margin-top: 8px;">
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                  <div style="margin-bottom: 4px;"><strong>Email:</strong> ${
                    project.email || "Information not available"
                  }</div>
                  <div style="margin-bottom: 4px;"><strong>Phone:</strong> ${
                    project.phone || "Information not available"
                  }</div>
                  ${
                    project.address
                      ? `
                    <div style="margin-bottom: 4px;"><strong>Address:</strong> ${
                      project.address.address_line1 ||
                      "Information not available"
                    }</div>
                    <div style="margin-bottom: 4px;"><strong>City:</strong> ${
                      project.address.city || "Information not available"
                    }</div>
                    <div><strong>Landmark:</strong> ${
                      project.address.landMark || "Information not available"
                    }</div>
                    `
                      : "Address information not available"
                  }
              </div>
              </div>
            `;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, contactDetailsContent),
                });
              } else if (action === "location") {
                const locationDetailsContent = `
              Location Details<br>
              <div style="margin-top: 8px;">
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                  ${
                    project.address
                      ? `
                    <div style="margin-bottom: 4px;"><strong>Address Line 1:</strong> ${
                      project.address.address_line1 || "Not available"
                    }</div>
                    <div style="margin-bottom: 4px;"><strong>Address Line 2:</strong> ${
                      project.address.address_line2 || "Not available"
                    }</div>
                    <div style="margin-bottom: 4px;"><strong>City:</strong> ${
                      project.address.city || "Not available"
                    }</div>
                    <div style="margin-bottom: 4px;"><strong>State:</strong> ${
                      project.address.state || "Not available"
                    } (${project.address.state_code || "NA"})</div>
                    <div style="margin-bottom: 4px;"><strong>Country:</strong> ${
                      project.address.country || "Not available"
                    } (${project.address.country_code || "NA"})</div>
                    <div style="margin-bottom: 4px;"><strong>Postal Code:</strong> ${
                      project.address.postcode || "Not available"
                    }</div>
                    <div style="margin-bottom: ${
                      project.address.lat ? "12px" : "0"
                    };"><strong>Coordinates:</strong> ${
                          project.address.lat
                            ? `${project.address.lat}, ${project.address.lon}`
                            : "Not available"
                        }</div>
                    ${
                      project.address.lat && project.address.lon
                        ? `
                      <div style="margin-top: 12px; height: 200px; border-radius: 4px; overflow: hidden;">
                        <iframe
                          width="100%"
                          height="100%"
                          frameborder="0"
                          style="border:0"
                          src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD-DxFifu1PRSbJZzPYZQVFChrsTEMwN74&q=${project.address.lat},${project.address.lon}&zoom=15"
                          allowfullscreen
                        ></iframe>
                      </div>
                      `
                        : ""
                    }
                    `
                      : "Location information not available"
                  }
                </div>
              </div>
            `;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, locationDetailsContent),
                });
              } else if (action === "possession") {
                const possessionDetailsContent = `
              Possession Details<br>
              <div style="margin-top: 8px;">
                <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                  <div style="margin-bottom: 4px;"><strong>Possession:</strong> ${
                    project.possession || "Information not available"
                  }</div>
                </div>
              </div>
            `;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(
                    project,
                    possessionDetailsContent
                  ),
                });
              } else if (action === "amenities") {
                const amenitiesContent =
                  project.amenities && project.amenities.length > 0
                    ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
                     ${project.amenities
                       .map(
                         (amenity) => `
                     <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                       <span style="font-size: 14px;">${
                         amenityIcons[amenity] || "✨"
                       }</span>
                       <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${amenity}</span>
                     </div>
                   `
                       )
                       .join("")}
                     </div>
                     <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                       <span style="font-size: 14px;">💡</span>
                       <span>These amenities are available to all residents.</span>
                     </div>`
                    : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
                     <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏠</span>
                     <span>No amenities information available for this project.</span>
                   </div>`;
                const amenitiesDetailsContent = `Amenities:<br>${amenitiesContent}`;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, amenitiesDetailsContent),
                });
              } else if (action === "nearby") {
                const nearbyContent =
                  project.proximities && project.proximities.length > 0
                    ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
                       ${project.proximities
                         .map(
                           (proximity) =>
                             `<div style="padding: 8px; background: white; border-radius: 6px; text-align: center; font-size: 12px; color: var(--text-color);">${proximity}</div>`
                         )
                         .join("")}
                       </div>`
                    : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
                       <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏘️</span>
                       <span>No nearby information available for this project.</span>
                     </div>`;
                const nearbyDetailsContent = `Nearby Places:<br>${nearbyContent}`;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, nearbyDetailsContent),
                });
              } else if (action === "interior") {
                const interiorContent =
                  project.interiorFeatures &&
                  project.interiorFeatures.length > 0
                    ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
                       ${project.interiorFeatures
                         .map(
                           (feature) => `
                       <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                         <span style="font-size: 14px;">🏠</span>
                         <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${feature}</span>
                       </div>
                     `
                         )
                         .join("")}
                       </div>
                       <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                         <span style="font-size: 14px;">💡</span>
                         <span>These features are available in the interior.</span>
                       </div>`
                    : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
                       <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏠</span>
                       <span>No interior features information available for this project.</span>
                     </div>`;
                const interiorDetailsContent = `Interior Features:<br>${interiorContent}`;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, interiorDetailsContent),
                });
              } else if (action === "exterior") {
                const exteriorContent =
                  project.exteriorFeatures &&
                  project.exteriorFeatures.length > 0
                    ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
                       ${project.exteriorFeatures
                         .map(
                           (feature) => `
                       <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                         <span style="font-size: 14px;">🏘️</span>
                         <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${feature}</span>
                       </div>
                     `
                         )
                         .join("")}
                       </div>
                       <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                         <span style="font-size: 14px;">💡</span>
                         <span>These features are available in the exterior.</span>
                       </div>`
                    : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
                       <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏘️</span>
                       <span>No exterior features information available for this project.</span>
                     </div>`;
                const exteriorDetailsContent = `Exterior Features:<br>${exteriorContent}`;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, exteriorDetailsContent),
                });
              } else if (action === "developer") {
                const developerDetailsContent = `
                Developer Information<br>
                <div style="margin-top: 8px;">
                  <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                    ${
                      chatbotSettings.developerProfile
                        ? `<div>
                            <p>${
                              chatbotSettings.developerProfile.description ||
                              "Not available"
                            }</p>
                            ${
                              chatbotSettings.developerProfile.image &&
                              `<img src="${
                                chatbotSettings.developerProfile.image.url || ""
                              }" alt="Developer Image" style="width: 100%; height: 200px; object-fit: cover; margin-top: 8px; border-radius: 4px;">`
                            }
                            </div>`
                        : `<div style="text-align: center; padding: 20px; color: var(--text-color);">
                             <span style="font-size: 18px; display: block; margin-bottom: 8px;">👷</span>
                             <span>Developer information not available</span>
                           </div>`
                    }
                        </div>
                </div>
              `;
                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, developerDetailsContent),
                });
              } else if (action === "siteVisit") {
                const siteVisitForm = `
                <div class="contact-form-container" id="visit-form-${formInputId}" style="max-width: 380px;">
                  <div class="contact-form-title">Schedule a Site Visit</div>
                  <div class="contact-form-subtitle">Please fill in your details to schedule a visit</div>
                  <div class="contact-form">
                    <div class="form-group">
                      <input
                        type="text"
                        id="visit-name-${formInputId}"
                        placeholder="Your full name"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <input
                        type="email"
                        id="visit-email-${formInputId}"
                        placeholder="Email address"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <input
                        type="tel"
                        id="visit-phone-${formInputId}"
                        name="phone"
                        placeholder="Phone number"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <input
                          type="date"
                          id="visit-date-${formInputId}"
                          required
                          min="${new Date().toISOString().split("T")[0]}"
                          style="color: #666;"
                        />
                      </div>
                      <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                          <input
                            type="time"
                            id="visit-start-time-${formInputId}"
                            required
                            style="color: #666;"
                          />
                        </div>
                        <div class="form-group" style="flex: 1;">
                          <input
                            type="time"
                            id="visit-end-time-${formInputId}"
                            required
                            style="color: #666;"
                          />
                        </div>
                      </div>
                      <button onclick="handleSiteVisitSubmit('${
                        project._id
                      }', ${formInputId})" id="site-visit-btn-${formInputId}" class="contact-submit-btn">
                        <span class="btn-text">Schedule Visit</span>
                        <span class="btn-loading" style="display: none;">Scheduling...</span>
                      </button>
                    </div>
                  </div>
                `;

                messages.push({
                  sender: "bot",
                  html: formatProjectResponse(project, siteVisitForm),
                });

                // Initialize phone input with the same configuration as contact form
                setTimeout(() => {
                  const formContainer = document.querySelector(
                    `#visit-form-${formInputId}`
                  );
                  if (formContainer) {
                    const phoneInput = formContainer.querySelector(
                      `#visit-phone-${formInputId}`
                    );
                    if (phoneInput) {
                      const phoneInputInstance = window.intlTelInput(
                        phoneInput,
                        {
                          initialCountry: "in",
                          separateDialCode: true,
                          utilsScript:
                            "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                        }
                      );
                      phoneInputInstances[formInputId] = phoneInputInstance;
                    }
                    formInputId++;
                  }
                }, 0);
              } else if (action === "brochure") {
                if (project.brochure && project.brochure.url) {
                  const brochureContent = `
                    <div style="margin-top: 8px;">
                      <div style="background: white; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                        <div style="display: flex; justify-content: center; padding: 12px;">
                          <a href="${project.brochure.url}" target="_blank" style="text-decoration: none;">
                            <button style="background: white; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 10px 20px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                              <span>📄</span>
                              Download Brochure
                            </button>
                          </a>
                        </div>
                      </div>
                    </div>
                  `;
                  messages.push({
                    sender: "bot",
                    html: formatProjectResponse(project, brochureContent),
                  });
                } else {
                  messages.push({
                    sender: "bot",
                    html: formatProjectResponse(
                      project,
                      "<div style='color: var(--text-color);'>Brochure is not available for this project.</div>"
                    ),
                  });
                }
                appendNewMessages();
              }
            }
            appendNewMessages();
          };

          window.sendMessage = function () {
            const text = chatInput.value.trim();
            if (!text) return;

            messages.push({ sender: "user", text: text });
            chatInput.value = "";
            appendNewMessages();

            // Detect which keywords are present in the user message.
            const keywordMatches = detectKeywords(text);

            setTimeout(() => {
              // Define the list of available actions (excluding greetings)
              let actions = [];
              const availableActions = [
                "projects",
                "pricing",
                "blocks",
                "contact",
                "location",
                "amenities",
                "nearby",
                "possession",
                "interior",
                "exterior",
                "developer",
                "siteVisit",
                "brochure",
                "upcomingProjects",
                "pastProjects",
              ];

              // Filter out the actions based on the detected keyword matches.
              availableActions.forEach((action) => {
                if (keywordMatches[action]) actions.push(action);
              });

              if (actions.length === 0) {
                // If no action keyword is detected, check if it's a greeting.
                const isGreeting = keywordMappings.greetings.some((greeting) =>
                  text.toLowerCase().includes(greeting)
                );
                if (isGreeting) {
                  messages.push({
                    sender: "bot",
                    text: "Hello! I'm your assistant. Here are some options to explore:",
                  });

                  messages.push({
                    sender: "bot",
                    html: `
              <div class="mt-4">
                <button onclick="handleProjectAction(null, 'upcomingProjects')" class="flex-1 px-4 py-2 w-max rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
                  <span class="text-base">🔜</span>Upcoming Projects
                </button>
                <button onclick="handleProjectAction(null, 'pastProjects')" class="flex-1 px-4 py-2 w-max rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
                  <span class="text-base">📅</span>Past Projects
                </button>
                <button onclick="handleOrgAction('siteVisit')" class="w-max flex-1 px-4 py-2 bg-primary rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
                  <span class="text-base">🏢</span>Visit our office
                </button>
              </div>
              <div style="margin-top: 16px;">Or select from our current projects:</div>
            `,
                  });
                } else {
                  messages.push({
                    sender: "bot",
                    text: "I apologize, but I couldn't find a specific answer to your question. Please provide your contact details and our team will get back to you shortly.",
                  });
                  messages.push({
                    sender: "bot",
                    html: renderContactForm(),
                  });
                }
              } else {
                let project =
                  currentProject ||
                  (projectsData.length > 0 ? projectsData[0] : null);
                if (project) {
                  currentProject = project;
                  if (actions.includes("projects")) {
                    messages.push({
                      sender: "bot",
                      text:
                        "Here are our available projects (current: " +
                        project.displayName +
                        "):",
                    });
                    messages.push({
                      sender: "bot",
                      html: renderProjects(projectsData),
                    });
                    actions = actions.filter((action) => action !== "projects");
                  }
                  if (actions.length > 0) {
                    handleProjectAction(project.projectIdCode, actions[0]);
                  }
                }
              }
              appendNewMessages();
            }, 500);
          };

          initialRenderMessages();

          const palData = localStorage.getItem("reallistChatbotPalData");
          if (palData) {
            const { displayName } = JSON.parse(palData);
            if (displayName) {
              messages.push({
                sender: "bot",
                text: `Hi ${displayName}! Choose a project to learn more about it.`,
              });
              appendNewMessages();
            }
          } else {
            messages.push({
              sender: "bot",
              text: "Hello! I'm your assistant. Here are our current projects:",
            });

            if (projectsData.length > 0) {
              messages.push({
                sender: "bot",
                html: renderProjects(projectsData),
              });
            }

            messages.push({
              sender: "bot",
              html: `
        <div>You can also explore:</div>
        <div class="mt-4">
          <button onclick="handleProjectAction(null, 'upcomingProjects')" class="w-max flex-1 px-4 py-2 bg-primary rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
            <span class="text-base">🔜</span>Upcoming Projects
          </button>
          <button onclick="handleProjectAction(null, 'pastProjects')" class="w-max flex-1 px-4 py-2 bg-primary rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
            <span class="text-base">📅</span>Past Projects
          </button>
          <button onclick="handleOrgAction('siteVisit')" class="w-max flex-1 px-4 py-2 bg-primary rounded-lg cursor-pointer font-medium flex items-center justify-center gap-1 hover:opacity-90 transition-all border border-[var(--button-border-color)]">
            <span class="text-base">🏢</span>Visit our office
          </button>
        </div>
      `,
            });
            appendNewMessages();

            setTimeout(() => {
              if (projectsData.length > 0) {
                initializeCarousel("projects", projectsData.length);
              }
            }, 100);
          }
        } catch (error) {
          console.error("Error fetching chatbot settings:", error);
          messages.push({
            sender: "bot",
            text: "I apologize, but I'm having trouble connecting to the assistant. Please try again later or refresh the page.",
          });
          appendNewMessages();
        }
      };

      getChatbotSettings();

      function renderContactForm() {
        if (phoneInputInstances[formInputId]) {
          phoneInputInstances[formInputId].destroy();
          phoneInputInstances[formInputId] = null;
        }

        const formHtml = `
  <div class="contact-form-container" id="contact-form-${formInputId}">
    <div class="contact-form-title">Contact Information</div>
    <div class="contact-form-subtitle">Please enter your details and we'll get back to you shortly</div>
    <div class="contact-form">
      <div class="form-group">
        <input
          type="text"
          id="name"
          placeholder="Your full name"
          required
        />
      </div>
      <div class="form-group">
        <input
          type="email"
          id="email"
          placeholder="Email address"
          required
        />
      </div>
      <div class="form-group">
        <input
          type="tel"
          id="phone"
          name="phone"
          placeholder="Phone number"
          required
        />
      </div>
      <button onclick="submitContactForm(${formInputId})" id="contact-submit-btn-${formInputId}" class="contact-submit-btn">
        <span class="btn-text">Submit</span>
        <span class="btn-loading" style="display: none;">Submitting...</span>
      </button>
    </div>
  </div>
`;

        setTimeout(() => {
          const formContainer = document.querySelector(
            `#contact-form-${formInputId}`
          );
          if (formContainer) {
            const phoneInput = formContainer.querySelector("#phone");
            if (phoneInput) {
              phoneInputInstance = window.intlTelInput(phoneInput, {
                initialCountry: "in",
                separateDialCode: true,
                utilsScript:
                  "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
              });
              phoneInputInstances[formInputId] = phoneInputInstance;
            }
            formInputId++;
          } else {
            console.error("Form container not found");
          }
        }, 0);
        return formHtml;
      }

      async function submitContactForm(formInputId) {
        const submitButton = document.querySelector(
          `#contact-submit-btn-${formInputId}`
        );
        const btnText = submitButton.querySelector(".btn-text");
        const btnLoading = submitButton.querySelector(".btn-loading");

        submitButton.disabled = true;
        btnText.style.display = "none";
        btnLoading.style.display = "inline";

        try {
          const name = document.querySelector(
            `#contact-form-${formInputId} #name`
          ).value;
          const email = document.querySelector(
            `#contact-form-${formInputId} #email`
          ).value;
          const phone = phoneInputInstances[formInputId]
            ? phoneInputInstances[formInputId].getNumber()
            : document.querySelector(`#contact-form-${formInputId} #phone`)
                .value;

          if (!name || !email || !phone) {
            messages.push({
              sender: "bot",
              text: "Please fill in all fields to submit your contact information.",
            });
            appendNewMessages();
            return;
          }

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid email address.",
            });
            appendNewMessages();
            return;
          }

          const phoneRegex = /^\d{10,}$/;
          if (!phoneRegex.test(phone.replace(/\D/g, ""))) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid phone number (at least 10 digits).",
            });
            appendNewMessages();
            return;
          }

          const response = await fetch(
            `${serverUrl}api/issue/create-with-lead`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                leadDetails: { name, email, phone },
                chatbotSettingsId: chatbotId,
              }),
            }
          );
          if (response.ok) {
            messages.push({
              sender: "bot",
              text: `Thank you for providing your contact information. Our team will get back to you soon!`,
            });
            const { data } = await response.json();
            if (data?.palData) {
              localStorage.setItem(
                "reallistChatbotPalData",
                JSON.stringify(data.palData)
              );
            }
          } else {
            messages.push({
              sender: "bot",
              text: "There was an error submitting your contact information. Please try again later.",
            });
          }
        } catch (error) {
          console.error("Error submitting contact form:", error);
          messages.push({
            sender: "bot",
            text: "There was an error submitting your contact information. Please try again later.",
          });
        } finally {
          submitButton.disabled = false;
          btnText.style.display = "inline";
          btnLoading.style.display = "none";
        }
        appendNewMessages();
      }

      window.handleSiteVisitSubmit = async function (projectId, formId) {
        const submitButton = document.querySelector(
          `#site-visit-btn-${formId}`
        );
        const btnText = submitButton.querySelector(".btn-text");
        const btnLoading = submitButton.querySelector(".btn-loading");

        submitButton.disabled = true;
        btnText.style.display = "none";
        btnLoading.style.display = "inline";

        try {
          const name = document.querySelector(`#visit-name-${formId}`).value;
          const email = document.querySelector(`#visit-email-${formId}`).value;
          const phone = phoneInputInstances[formId]
            ? phoneInputInstances[formId].getNumber()
            : document.querySelector(`#visit-phone-${formId}`).value;
          const date = document.querySelector(`#visit-date-${formId}`).value;
          const startTime = document.querySelector(
            `#visit-start-time-${formId}`
          ).value;
          const endTime = document.querySelector(
            `#visit-end-time-${formId}`
          ).value;
          const project = projectsData.find((p) => p._id === projectId);

          if (!name || !email || !phone || !date || !startTime || !endTime) {
            messages.push({
              sender: "bot",
              text: "Please fill in all fields to schedule your site visit.",
            });
            appendNewMessages();
            return;
          }

          const startDate = new Date(`${date}T${startTime}`);
          const endDate = new Date(`${date}T${endTime}`);

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid email address.",
            });
            appendNewMessages();
            return;
          }

          const phoneRegex = /^\d{10,}$/;
          if (!phoneRegex.test(phone.replace(/\D/g, ""))) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid phone number (at least 10 digits).",
            });
            appendNewMessages();
            return;
          }

          const formData = {
            details: [
              {
                leadDetails: {
                  name: name,
                  email: email,
                  phone: phone,
                },
              },
            ],
            projectProfile: project.profile,
            organizationProfile: project.ownerProfile._id,
            issueTemplateId: project.siteVisitTeam || issueTemplateId,
            actionActivityDetails: {
              title: `Site visit - ${name}`,
              description: `Site visit generated by chatbot for ${name}`,
              startDate: startDate.toISOString(),
              endDate: endDate.toISOString(),
            },
            chatbotId: chatbotId,
          };

          const res = await fetch(
            `${serverUrl}api/issue/create/multiple-with-lead`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          if (res.ok) {
            messages.push({
              sender: "bot",
              text: "Thank you for scheduling a site visit. Our team will contact you shortly to confirm the details.",
            });
          } else {
            messages.push({
              sender: "bot",
              text: "There was an error scheduling your site visit. Please try again later.",
            });
          }
          appendNewMessages();
        } catch (error) {
          console.error("Error scheduling site visit:", error);
          messages.push({
            sender: "bot",
            text: "There was an error scheduling your site visit. Please try again later.",
          });
        } finally {
          submitButton.disabled = false;
          btnText.style.display = "inline";
          btnLoading.style.display = "none";
        }
      };

      function showProjectDetails(project) {
        messages.push({
          sender: "bot",
          html: `
    <div class="project-details-container">
      ${
        project.docs &&
        project.docs.some((doc) => doc.files && doc.files.length > 0)
          ? `
          <div class="project-carousel">
            <div class="carousel-controls">
              <button onclick="moveCarousel('project-images', 'prev')" class="carousel-btn" style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--button-border-color); cursor: pointer; margin-right: 8px;">←</button>
              <span id="project-images-counter">1/${project.docs.reduce(
                (count, doc) => count + (doc.files ? doc.files.length : 0),
                0
              )}</span>
              <button onclick="moveCarousel('project-images', 'next')" class="carousel-btn" style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--button-border-color); cursor: pointer; margin-left: 8px;">→</button>
            </div>
            <div class="carousel-container" id="project-images-carousel" style="overflow: hidden; width: 100%;">
              <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: 100%;">
                        ${project.docs
                          .filter((doc) => doc.files && doc.files.length > 0)
                          .map((doc) =>
                            doc.files
                              .map(
                                (file) => `
                        <div class="carousel-slide" style="flex: 0 0 100%; min-width: 100%; width: 100%; padding: 0 8px;">
                          <img src="${file.url}"
                               alt="${project.displayName}"
                               style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px;"
                          />
                          ${
                            doc.title
                              ? `<div style="margin-top: 8px; font-weight: 500;">${doc.title}</div>`
                              : ""
                          }
                          ${
                            doc.description
                              ? `<div style="font-size: 14px; color: var(--text-color);">${doc.description}</div>`
                              : ""
                          }
                        </div>
                      `
                              )
                              .join("")
                          )
                          .join("")}
              </div>
            </div>
          </div>
          `
          : project.displayPicture
          ? `
          <div class="project-image">
            <img src="${project.displayPicture.url}"
                 alt="${project.displayName}"
                 style="width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 16px;"
            />
          </div>
        `
          : ""
      }

      <div class="project-header">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${
          project.displayName
        }</h3>
        ${
          project.description
            ? `<p style="font-size: 14px; color: var(--text-color); margin-bottom: 16px;">${project.description}</p>`
            : ""
        }
      </div>

      <div class="project-info-grid" style="display: grid; gap: 12px; margin-bottom: 16px;">
        ${
          project.area
            ? `
          <div class="info-item">
            <span class="label" style="font-weight: 500;">Area:</span>
            <span>${project.area} sq ft</span>
          </div>
        `
            : ""
        }

        ${
          project.address
            ? `
          <div class="info-item">
            <span class="label" style="font-weight: 500;">Location:</span>
            <span>${project.address.city}${
                project.address.state ? `, ${project.address.state}` : ""
              }</span>
          </div>
        `
            : ""
        }

        ${
          project.email
            ? `
          <div class="info-item">
            <span class="label" style="font-weight: 500;">Contact:</span>
            <span>${project.email}</span>
          </div>
        `
            : ""
        }
      </div>

      <div class="project-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button onclick="handleProjectAction('${project._id}', 'schedule')"
                style="flex: 1; min-width: 120px; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
          Schedule Visit
        </button>
        <button onclick="handleProjectAction('${project._id}', 'contact')"
                style="flex: 1; min-width: 120px; padding: 8px 16px; background: var(--primary-lighter); color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 6px; cursor: pointer;">
          Contact Us
        </button>
        ${
          project.brochure
            ? `
          <button onclick="window.open('${project.brochure.url}', '_blank')"
                  style="flex: 1; min-width: 120px; padding: 8px 16px; background: var(--secondary-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
            Download Brochure
          </button>
        `
            : ""
        }
      </div>
    </div>
  `,
        });
        appendNewMessages();

        // Initialize carousel if docs with files exist
        if (
          project.docs &&
          project.docs.some((doc) => doc.files && doc.files.length > 0)
        ) {
          setTimeout(() => {
            const totalImages = project.docs.reduce(
              (count, doc) => count + (doc.files ? doc.files.length : 0),
              0
            );
            initializeCarousel("project-images", totalImages);
          }, 0);
        }
      }

      function handleProjectAction(projectId, action) {
        let project;
        if (projectId) {
          project = projectsData.find((p) => p.projectIdCode === projectId);
          if (!project) return;
        }

        if (action === "pricing" && project) {
          const pricingDetailsContent = `
    Pricing Details<br>
    <div style="margin-top: 8px;">
      <div style="background: white; padding: 12px; border-radius: 8px;">
        ${
          project.pricing && project.pricing.length > 0
            ? `
        <div style="margin-top: 12px;">
          <strong>Additional Pricing Details:</strong>
          <div style="margin-top: 8px;">
            ${project.pricing
              .map(
                (price) => `
                <div style="margin-bottom: 4px; display: flex; justify-content: space-between;">
                  <span>${price.title}:</span>
                  <span>₹${numberWithCommas(price.value)}</span>
                </div>`
              )
              .join("")}
          </div>
        </div>
        `
            : "Pricing information is not available."
        }
      </div>
    </div>
  `;
          messages.push({
            sender: "bot",
            html: formatProjectResponse(project, pricingDetailsContent),
          });
          appendNewMessages();
        } else if (action === "upcomingProjects") {
          if (
            chatbotSettings.upcomingProjects &&
            chatbotSettings.upcomingProjects.length > 0
          ) {
            const upcomingProjectsContent = `
      <div>
        <div style="background: white; border-radius: 8px; max-width: 100%; position: relative;">
          <div style="font-weight: 600; margin: 12px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 15px; letter-spacing: -0.2px;">Upcoming Projects</span>
            </div>
          
          <!-- Position controls as an overlay that extends outside -->
          <div class="carousel-controls" style="position: absolute; top: 50%; transform: translateY(-50%); left: -20px; right: -20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 2;">
            <button onclick="moveCarousel('upcoming', 'prev')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">←</button>
            <button onclick="moveCarousel('upcoming', 'next')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">→</button>
          </div>

          <div style="text-align: center; margin-bottom: 8px;">
            <span id="upcoming-counter">1/${
              chatbotSettings.upcomingProjects.length
            }</span>
            </div>
          
          <div class="carousel-container" id="upcoming-carousel" style="overflow: hidden; max-width: 100%; margin: 0 auto;">
            <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: 100%;">
              ${chatbotSettings.upcomingProjects
                .map(
                  (projectExp) => `
                <div class="carousel-slide" style="flex: 0 0 100%; min-width: 100%; width: 100%; box-sizing: border-box; padding: 0 16px 16px;">
                  ${
                    projectExp.project?.displayPicture
                      ? `<div style="margin-bottom: 12px;">
                          <img src="${projectExp.project.displayPicture.url}"
                               alt="${projectExp.project.displayName}"
                               style="width: 100%; height: 160px; object-fit: cover; border-radius: 6px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);"
                              />
                            </div>`
                      : ""
                  }
                      <h3 style="font-weight: 600; margin-bottom: 8px; word-wrap: break-word; font-size: 15px; letter-spacing: -0.3px; line-height: 1.3;">${
                        projectExp.project?.displayName || "Unnamed Project"
                      }</h3>

                      ${
                        projectExp.project?.description
                          ? `<p style="margin-bottom: 12px; font-size: 12px; line-height: 1.4; word-wrap: break-word; color: rgba(0, 0, 0, 0.7);">${projectExp.project.description}</p>`
                          : ""
                      }

                      <div style="display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; margin-bottom: 14px; font-size: 11px; line-height: 1.4;">
                        ${
                          projectExp.project?.address
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Location:</div>
                              <div>${projectExp.project.address.city || ""}${
                                projectExp.project.address.state
                                  ? `, ${projectExp.project.address.state}`
                                  : ""
                              }${
                                projectExp.project.address.fullAddress
                                  ? `<div style="margin-top: 2px; font-size: 12px; color: rgba(0, 0, 0, 0.6);">${projectExp.project.address.fullAddress}</div>`
                                  : ""
                              }
                              </div>`
                            : ""
                        }

                        ${
                          projectExp.project?.projectType
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Type:</div>
                              <div>${projectExp.project.projectType}</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.startDate
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Start Date:</div>
                              <div>${new Date(
                                projectExp.project.startDate
                              ).toLocaleDateString("en-US", {
                                year: "numeric",
                                month: "short",
                                day: "numeric",
                              })}</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.projectSize
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Project Size:</div>
                              <div>${projectExp.project.projectSize}</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.area
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Area:</div>
                              <div>${projectExp.project.area} sq ft</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.budget
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Budget:</div>
                              <div>₹${numberWithCommas(
                                projectExp.project.budget
                              )}</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.email
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Email:</div>
                              <div>${projectExp.project.email}</div>`
                            : ""
                        }

                        ${
                          projectExp.project?.phone
                            ? `<div style="font-weight: 500; color: rgba(0, 0, 0, 0.75);">Phone:</div>
                              <div>${projectExp.project.phone}</div>`
                            : ""
                        }
                      </div>

                      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px;">
                        ${
                          projectExp.project?.brochure
                            ? `<a href="${projectExp.project.brochure.url}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                <span style="margin-right: 6px; font-size: 12px;">📄</span> Download Brochure
                              </a>`
                            : ""
                        }
                        ${
                          projectExp.project?.siteLink
                            ? `<a href="${projectExp.project.siteLink}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                <span style="margin-right: 6px; font-size: 12px;">🌐</span> Visit Website
                              </a>`
                            : ""
                        }
                        ${
                          projectExp.project?.mediaLink
                            ? `<a href="${projectExp.project.mediaLink}" target="_blank" style="display: inline-flex; align-items: center; text-decoration: none; color: var(--primary-color); background-color: rgba(0, 122, 255, 0.05); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; transition: all 0.2s;">
                                <span style="margin-right: 6px; font-size: 12px;">🎬</span> View Media
                              </a>`
                            : ""
                        }
                      </div>
                    </div>
                  `
                )
                .join("")}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
            messages.push({
              sender: "bot",
              html: upcomingProjectsContent,
            });
            // Initialize carousel after content is added
            setTimeout(() => {
              initializeCarousel(
                "upcoming",
                chatbotSettings.upcomingProjects.length
              );
            }, 0);
          } else {
            messages.push({
              sender: "bot",
              text: "No upcoming projects available at the moment.",
            });
          }
          appendNewMessages();
        } else if (action === "pastProjects") {
          if (
            chatbotSettings.pastProjects &&
            chatbotSettings.pastProjects.length > 0
          ) {
            const pastProjectsContent = `
      <div>
        <div style="background: white; border-radius: 8px; max-width: 300px; position: relative;">
          <div style="font-weight: 600; margin: 12px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 15px; letter-spacing: -0.2px;">Past Projects</span>
          </div>
          
          <!-- Position controls as an overlay that extends outside -->
          <div class="carousel-controls" style="position: absolute; top: 50%; transform: translateY(-50%); left: -20px; right: -20px; display: flex; justify-content: space-between; align-items: center; pointer-events: none; z-index: 2;">
            <button onclick="moveCarousel('past', 'prev')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">←</button>
            <button onclick="moveCarousel('past', 'next')" style="background: white; color: var(--primary-color); border: 1px solid var(--button-border-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; pointer-events: auto; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">→</button>
          </div>
          
          <div style="text-align: center; margin-bottom: 8px;">
            <span id="past-counter">1/${
              chatbotSettings.pastProjects.length
            }</span>
          </div>
          
          <div class="carousel-container" id="past-carousel" style="overflow: hidden; max-width: 300px; margin: 0 auto;">
            <div class="carousel-track" style="display: flex; transition: transform 0.3s ease; width: ${
              chatbotSettings.pastProjects.length * 300
            }px;">
              ${chatbotSettings.pastProjects
                .map(
                  (project, index) => `
                <div class="carousel-item" style="flex: 0 0 300px; max-width: 300px; padding: 0 12px;">
                  <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                    ${
                      project.project.displayPicture
                        ? `<img src="${project.project.displayPicture.url}" alt="${project.project.displayName}" style="width: 100%; height: 150px; object-fit: cover;">`
                        : ""
                    }
                    <div style="padding: 12px;">
                      <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">${
                        project.project.displayName
                      }</div>
                      <div style="color: var(--text-color-secondary); font-size: 12px; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${
                        project.project.description
                      }</div>
                      <div style="margin-bottom: 8px;">
                        <div style="color: var(--text-color-secondary); font-size: 12px;">Location:</div>
                        <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${
                          project.project.address.city
                        }, ${project.project.address.state}</div>
                      </div>
                      <div style="margin-bottom: 8px;">
                        <div style="color: var(--text-color-secondary); font-size: 12px;">Timeline:</div>
                        <div style="font-size: 12px;">${project.startMonth} ${
                    project.startYear
                  } - ${
                    project.isCurrentlyWorking
                      ? "Present"
                      : `${project.endMonth} ${project.endYear}`
                  }</div>
                      </div>
                      ${
                        project.project.amenities &&
                        project.project.amenities.length > 0
                          ? `
                        <div style="margin-bottom: 8px;">
                          <div style="color: var(--text-color-secondary); font-size: 12px;">Amenities:</div>
                          <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${project.project.amenities.join(
                            ", "
                          )}</div>
                        </div>`
                          : ""
                      }
                      <div style="display: flex; gap: 8px; margin-top: 12px;">
                        ${
                          project.project.siteLink
                            ? `<a href="${project.project.siteLink}" target="_blank" style="flex: 1; padding: 6px 12px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-size: 12px; text-align: center;">Visit Website</a>`
                            : ""
                        }
                        ${
                          project.project.mediaLink
                            ? `<a href="${project.project.mediaLink}" target="_blank" style="flex: 1; padding: 6px 12px; background: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-size: 12px; text-align: center;">View Media</a>`
                            : ""
                        }
                      </div>
                    </div>
                  </div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        </div>
      </div>
    `;
            messages.push({
              sender: "bot",
              html: pastProjectsContent,
            });

            setTimeout(() => {
              initializeCarousel("past", chatbotSettings.pastProjects.length);
            }, 0);
          } else {
            messages.push({
              sender: "bot",
              text: "No past projects available at the moment.",
            });
          }
          appendNewMessages();
        } else if (projectId) {
          if (action === "contact") {
            const contactDetailsContent = `
      Contact Information<br>
      <div style="margin-top: 8px;">
        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
          <div style="margin-bottom: 4px;"><strong>Email:</strong> ${
            project.email || "Information not available"
          }</div>
          <div style="margin-bottom: 4px;"><strong>Phone:</strong> ${
            project.phone || "Information not available"
          }</div>
          ${
            project.address
              ? `
            <div style="margin-bottom: 4px;"><strong>Address:</strong> ${
              project.address.address_line1 || "Information not available"
            }</div>
            <div style="margin-bottom: 4px;"><strong>City:</strong> ${
              project.address.city || "Information not available"
            }</div>
            <div><strong>Landmark:</strong> ${
              project.address.landMark || "Information not available"
            }</div>
            `
              : "Address information not available"
          }
      </div>
      </div>
    `;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, contactDetailsContent),
            });
          } else if (action === "location") {
            const locationDetailsContent = `
      Location Details<br>
      <div style="margin-top: 8px;">
        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
          ${
            project.address
              ? `
            <div style="margin-bottom: 4px;"><strong>Address Line 1:</strong> ${
              project.address.address_line1 || "Not available"
            }</div>
            <div style="margin-bottom: 4px;"><strong>Address Line 2:</strong> ${
              project.address.address_line2 || "Not available"
            }</div>
            <div style="margin-bottom: 4px;"><strong>City:</strong> ${
              project.address.city || "Not available"
            }</div>
            <div style="margin-bottom: 4px;"><strong>State:</strong> ${
              project.address.state || "Not available"
            } (${project.address.state_code || "NA"})</div>
            <div style="margin-bottom: 4px;"><strong>Country:</strong> ${
              project.address.country || "Not available"
            } (${project.address.country_code || "NA"})</div>
            <div style="margin-bottom: 4px;"><strong>Postal Code:</strong> ${
              project.address.postcode || "Not available"
            }</div>
            <div style="margin-bottom: ${
              project.address.lat ? "12px" : "0"
            };"><strong>Coordinates:</strong> ${
                  project.address.lat
                    ? `${project.address.lat}, ${project.address.lon}`
                    : "Not available"
                }</div>
            ${
              project.address.lat && project.address.lon
                ? `
              <div style="margin-top: 12px; height: 200px; border-radius: 4px; overflow: hidden;">
                <iframe
                  width="100%"
                  height="100%"
                  frameborder="0"
                  style="border:0"
                  src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD-DxFifu1PRSbJZzPYZQVFChrsTEMwN74&q=${project.address.lat},${project.address.lon}&zoom=15"
                  allowfullscreen
                ></iframe>
              </div>
              `
                : ""
            }
            `
              : "Location information not available"
          }
        </div>
      </div>
    `;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, locationDetailsContent),
            });
          } else if (action === "possession") {
            const possessionDetailsContent = `
      Possession Details<br>
      <div style="margin-top: 8px;">
        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
          <div style="margin-bottom: 4px;"><strong>Possession:</strong> ${
            project.possession || "Information not available"
          }</div>
        </div>
      </div>
    `;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, possessionDetailsContent),
            });
          } else if (action === "amenities") {
            const amenitiesContent =
              project.amenities && project.amenities.length > 0
                ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
             ${project.amenities
               .map(
                 (amenity) => `
             <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
               <span style="font-size: 14px;">${
                 amenityIcons[amenity] || "✨"
               }</span>
               <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${amenity}</span>
             </div>
           `
               )
               .join("")}
             </div>
             <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
               <span style="font-size: 14px;">💡</span>
               <span>These amenities are available to all residents.</span>
             </div>`
                : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
               <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏠</span>
               <span>No amenities information available for this project.</span>
             </div>`;
            const amenitiesDetailsContent = `Amenities:<br>${amenitiesContent}`;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, amenitiesDetailsContent),
            });
          } else if (action === "nearby") {
            const nearbyContent =
              project.proximities && project.proximities.length > 0
                ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
               ${project.proximities
                 .map(
                   (proximity) =>
                     `<div style="padding: 8px; background: white; border-radius: 6px; text-align: center; font-size: 12px; color: var(--text-color);">${proximity}</div>`
                 )
                 .join("")}
               </div>`
                : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
             <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏘️</span>
             <span>No nearby information available for this project.</span>
           </div>`;
            const nearbyDetailsContent = `Nearby Places:<br>${nearbyContent}`;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, nearbyDetailsContent),
            });
          } else if (action === "interior") {
            const interiorContent =
              project.interiorFeatures && project.interiorFeatures.length > 0
                ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
               ${project.interiorFeatures
                 .map(
                   (feature) => `
               <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                 <span style="font-size: 14px;">🏠</span>
                 <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${feature}</span>
               </div>
             `
                 )
                 .join("")}
               </div>
               <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                 <span style="font-size: 14px;">💡</span>
                 <span>These features are available in the interior.</span>
               </div>`
                : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
               <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏠</span>
               <span>No interior features information available for this project.</span>
             </div>`;
            const interiorDetailsContent = `Interior Features:<br>${interiorContent}`;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, interiorDetailsContent),
            });
          } else if (action === "exterior") {
            const exteriorContent =
              project.exteriorFeatures && project.exteriorFeatures.length > 0
                ? `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 6px;">
               ${project.exteriorFeatures
                 .map(
                   (feature) => `
               <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                 <span style="font-size: 14px;">🏘️</span>
                 <span style="font-size: 12px; color: var(--text-color); font-weight: 500;">${feature}</span>
               </div>
             `
                 )
                 .join("")}
               </div>
               <div style="margin-top: 12px; padding: 8px; background: color-mix(in srgb, var(--primary-color) 8%, transparent); border-radius: 6px; font-size: 12px; color: var(--text-color); display: flex; align-items: center; gap: 6px;">
                 <span style="font-size: 14px;">💡</span>
                 <span>These features are available in the exterior.</span>
               </div>`
                : `<div style="padding: 16px; text-align: center; color: var(--text-color); background: white; border-radius: 6px; font-size: 12px;">
               <span style="font-size: 18px; display: block; margin-bottom: 6px;">🏘️</span>
               <span>No exterior features information available for this project.</span>
             </div>`;
            const exteriorDetailsContent = `Exterior Features:<br>${exteriorContent}`;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, exteriorDetailsContent),
            });
          } else if (action === "developer") {
            const developerDetailsContent = `
        Developer Information<br>
        <div style="margin-top: 8px;">
          <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
            ${
              chatbotSettings.developerProfile
                ? `<div>
                    <p>${
                      chatbotSettings.developerProfile.description ||
                      "Not available"
                    }</p>
                    ${
                      chatbotSettings.developerProfile.image &&
                      `<img src="${
                        chatbotSettings.developerProfile.image.url || ""
                      }" alt="Developer Image" style="width: 100%; height: 200px; object-fit: cover; margin-top: 8px; border-radius: 4px;">`
                    }
                    </div>`
                : `<div style="text-align: center; padding: 20px; color: var(--text-color);">
                     <span style="font-size: 18px; display: block; margin-bottom: 8px;">👷</span>
                     <span>Developer information not available</span>
                   </div>`
            }
                </div>
        </div>
      `;
            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, developerDetailsContent),
            });
          } else if (action === "siteVisit") {
            const siteVisitForm = `
        <div class="contact-form-container" id="visit-form-${formInputId}" style="max-width: 380px;">
          <div class="contact-form-title">Schedule a Site Visit</div>
          <div class="contact-form-subtitle">Please fill in your details to schedule a visit</div>
          <div class="contact-form">
            <div class="form-group">
              <input
                type="text"
                id="visit-name-${formInputId}"
                placeholder="Your full name"
                required
              />
            </div>
            <div class="form-group">
              <input
                type="email"
                id="visit-email-${formInputId}"
                placeholder="Email address"
                required
              />
            </div>
            <div class="form-group">
              <input
                type="tel"
                id="visit-phone-${formInputId}"
                name="phone"
                placeholder="Phone number"
                required
              />
            </div>
            <div class="form-group">
              <input
                type="date"
                id="visit-date-${formInputId}"
                required
                min="${new Date().toISOString().split("T")[0]}"
                style="color: #666;"
              />
            </div>
            <div style="display: flex; gap: 10px;">
              <div class="form-group" style="flex: 1;">
                <input
                  type="time"
                  id="visit-start-time-${formInputId}"
                  required
                  style="color: #666;"
                />
              </div>
              <div class="form-group" style="flex: 1;">
                <input
                  type="time"
                  id="visit-end-time-${formInputId}"
                  required
                  style="color: #666;"
                />
              </div>
            </div>
            <button onclick="handleSiteVisitSubmit('${
              project._id
            }', ${formInputId})" id="site-visit-btn-${formInputId}" class="contact-submit-btn">
              <span class="btn-text">Schedule Visit</span>
              <span class="btn-loading" style="display: none;">Scheduling...</span>
            </button>
          </div>
        </div>
      `;

            messages.push({
              sender: "bot",
              html: formatProjectResponse(project, siteVisitForm),
            });

            // Initialize phone input with the same configuration as contact form
            setTimeout(() => {
              const formContainer = document.querySelector(
                `#visit-form-${formInputId}`
              );
              if (formContainer) {
                const phoneInput = formContainer.querySelector(
                  `#visit-phone-${formInputId}`
                );
                if (phoneInput) {
                  const phoneInputInstance = window.intlTelInput(phoneInput, {
                    initialCountry: "in",
                    separateDialCode: true,
                    utilsScript:
                      "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                  });
                  phoneInputInstances[formInputId] = phoneInputInstance;
                }
                formInputId++;
              }
            }, 0);
          } else if (action === "brochure") {
            if (project.brochure && project.brochure.url) {
              const brochureContent = `
          <div style="margin-top: 8px;">
            <div style="background: white; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
              <div style="display: flex; justify-content: center; padding: 12px;">
                <a href="${project.brochure.url}" target="_blank" style="text-decoration: none;">
                  <button style="background: white; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 10px 20px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <span>📄</span>
                    Download Brochure
                  </button>
                </a>
          </div>
        </div>
      </div>
    `;
              messages.push({
                sender: "bot",
                html: formatProjectResponse(project, brochureContent),
              });
            } else {
              messages.push({
                sender: "bot",
                html: formatProjectResponse(
                  project,
                  "<div style='color: var(--text-color);'>Brochure is not available for this project.</div>"
                ),
              });
            }
            appendNewMessages();
          }
        }
        appendNewMessages();
      }

      function handleOrgAction(action) {
        if (action === "siteVisit") {
          let locationOptions = "";
          let locationSelectionHtml = "";

          if (organizationLocations && organizationLocations.length > 0) {
            if (organizationLocations.length === 1) {
              const location = organizationLocations[0];
              let locationLabel = location?.name || "Unnamed Location";

              if (location.location) {
                let addressParts = [];

                if (location.location.address_line1) {
                  addressParts.push(location.location.address_line1);
                }

                let cityStateZip = "";
                if (location.location.city) {
                  cityStateZip += location.location.city;
                }

                if (location.location.state) {
                  if (cityStateZip) cityStateZip += ", ";
                  cityStateZip += location.location.state;
                }

                if (location.location.postcode) {
                  if (cityStateZip) cityStateZip += " ";
                  cityStateZip += location.location.postcode;
                }

                if (cityStateZip) {
                  addressParts.push(cityStateZip);
                }

                if (location.location.country) {
                  addressParts.push(location.location.country);
                }

                if (addressParts.length > 0) {
                  locationLabel += ` (${addressParts.join(", ")})`;
                }
              }

              locationOptions = `<option value="${location._id}" selected>${locationLabel}</option>`;
            } else {
              locationOptions = organizationLocations
                .map((location) => {
                  let locationLabel = location?.name || "Unnamed Location";

                  if (location.location) {
                    let addressParts = [];

                    if (location.location.address_line1) {
                      addressParts.push(location.location.address_line1);
                    }

                    let cityStateZip = "";
                    if (location.location.city) {
                      cityStateZip += location.location.city;
                    }

                    if (location.location.state) {
                      if (cityStateZip) cityStateZip += ", ";
                      cityStateZip += location.location.state;
                    }

                    if (location.location.postcode) {
                      if (cityStateZip) cityStateZip += " ";
                      cityStateZip += location.location.postcode;
                    }

                    if (cityStateZip) {
                      addressParts.push(cityStateZip);
                    }

                    if (location.location.country) {
                      addressParts.push(location.location.country);
                    }

                    if (addressParts.length > 0) {
                      locationLabel += ` (${addressParts.join(", ")})`;
                    }
                  }

                  return `<option value="${location._id}">${locationLabel}</option>`;
                })
                .join("");
            }

            locationSelectionHtml = `
          <div class="form-group">
            <style>
              #org-visit-location-${formInputId} {
                width: 100%;
                padding: 12px;
                border-radius: 6px;
                border: 1px solid #ddd;
                color: #666;
                background-color: white;
              }
              #org-visit-location-${formInputId} option {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                max-width: 200px;
              }
            </style>
            <select
              id="org-visit-location-${formInputId}"
              required
            >
              ${
                organizationLocations.length === 1
                  ? ""
                  : '<option value="" disabled selected>Select office location</option>'
              }
              ${locationOptions}
            </select>
          </div>
        `;
          } else {
            locationSelectionHtml = `
          <div class="form-group">
            <style>
              #org-visit-location-${formInputId} {
                width: 100%;
                padding: 12px;
                border-radius: 6px;
                border: 1px solid #ddd;
                color: #666;
                background-color: white;
              }
            </style>
            <select id="org-visit-location-${formInputId}" required>
              <option value="default" selected>Main Office</option>
            </select>
          </div>
        `;
          }

          const orgSiteVisitForm = `
      <div class="contact-form-container" id="org-visit-form-${formInputId}" style="max-width: 380px;">
        <div class="contact-form-title">Schedule a Visit to Our Office</div>
        <div class="contact-form-subtitle">Please fill in your details to schedule a visit to our organization office</div>
        <div class="contact-form">
          <div class="form-group">
            <input
              type="text"
              id="org-visit-name-${formInputId}"
              placeholder="Your full name"
              required
            />
          </div>
          <div class="form-group">
            <input
              type="email"
              id="org-visit-email-${formInputId}"
              placeholder="Email address"
              required
            />
          </div>
          <div class="form-group">
            <input
              type="tel"
              id="org-visit-phone-${formInputId}"
              name="phone"
              placeholder="Phone number"
              required
            />
          </div>
          ${locationSelectionHtml}
          <div class="form-group">
            <input
              type="date"
              id="org-visit-date-${formInputId}"
              required
              min="${new Date().toISOString().split("T")[0]}"
              style="color: #666;"
            />
          </div>
          <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
              <input
                type="time"
                id="org-visit-start-time-${formInputId}"
                required
                style="color: #666;"
              />
            </div>
            <div class="form-group" style="flex: 1;">
              <input
                type="time"
                id="org-visit-end-time-${formInputId}"
                required
                style="color: #666;"
              />
            </div>
          </div>
          <button onclick="handleOrgSiteVisitSubmit(${formInputId})" id="org-site-visit-btn-${formInputId}" class="contact-submit-btn">
            <span class="btn-text">Schedule Organization Visit</span>
            <span class="btn-loading" style="display: none;">Scheduling...</span>
          </button>
        </div>
      </div>
    `;

          messages.push({
            sender: "bot",
            html: orgSiteVisitForm,
          });

          setTimeout(() => {
            const formContainer = document.querySelector(
              `#org-visit-form-${formInputId}`
            );
            if (formContainer) {
              const phoneInput = formContainer.querySelector(
                `#org-visit-phone-${formInputId}`
              );
              if (phoneInput) {
                phoneInputInstance = window.intlTelInput(phoneInput, {
                  initialCountry: "in",
                  separateDialCode: true,
                  utilsScript:
                    "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                });
                phoneInputInstances[formInputId] = phoneInputInstance;
              }
              formInputId++;
            }
          }, 0);

          appendNewMessages();
        }
      }

      window.handleOrgSiteVisitSubmit = async function (formId) {
        const submitButton = document.querySelector(
          `#org-site-visit-btn-${formId}`
        );
        const btnText = submitButton.querySelector(".btn-text");
        const btnLoading = submitButton.querySelector(".btn-loading");

        submitButton.disabled = true;
        btnText.style.display = "none";
        btnLoading.style.display = "inline";

        try {
          const name = document.querySelector(
            `#org-visit-name-${formId}`
          ).value;
          const email = document.querySelector(
            `#org-visit-email-${formId}`
          ).value;
          const phone = phoneInputInstances[formId]
            ? phoneInputInstances[formId].getNumber()
            : document.querySelector(`#org-visit-phone-${formId}`).value;
          const date = document.querySelector(
            `#org-visit-date-${formId}`
          ).value;
          const startTime = document.querySelector(
            `#org-visit-start-time-${formId}`
          ).value;
          const endTime = document.querySelector(
            `#org-visit-end-time-${formId}`
          ).value;
          // Get selected location
          const locationSelect = document.querySelector(
            `#org-visit-location-${formId}`
          );
          const locationId = locationSelect.value;

          if (
            !name ||
            !email ||
            !phone ||
            !date ||
            !startTime ||
            !endTime ||
            !locationId
          ) {
            messages.push({
              sender: "bot",
              text: "Please fill in all fields to schedule your organization visit.",
            });
            appendNewMessages();
            return;
          }

          const startDate = new Date(`${date}T${startTime}`);
          const endDate = new Date(`${date}T${endTime}`);

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid email address.",
            });
            appendNewMessages();
            return;
          }

          const phoneRegex = /^\d{10,}$/;
          if (!phoneRegex.test(phone.replace(/\D/g, ""))) {
            messages.push({
              sender: "bot",
              text: "Please enter a valid phone number (at least 10 digits).",
            });
            appendNewMessages();
            return;
          }

          // Find selected location details
          let selectedLocationName = "Main Office"; // Default fallback
          let formattedAddress = "";

          if (
            organizationLocations &&
            organizationLocations.length > 0 &&
            locationId !== "default"
          ) {
            const selectedLocation = organizationLocations.find(
              (loc) => loc._id === locationId
            );

            if (selectedLocation) {
              selectedLocationName = selectedLocation.name || "Selected Office";

              // Build a formatted address string if location details available
              if (selectedLocation.location) {
                let addressParts = [];

                // Add address line 1
                if (selectedLocation.location.address_line1) {
                  addressParts.push(selectedLocation.location.address_line1);
                }

                // Format city, state, postcode
                let cityStateZip = "";
                if (selectedLocation.location.city) {
                  cityStateZip += selectedLocation.location.city;
                }

                if (selectedLocation.location.state) {
                  if (cityStateZip) cityStateZip += ", ";
                  cityStateZip += selectedLocation.location.state;
                }

                if (selectedLocation.location.postcode) {
                  if (cityStateZip) cityStateZip += " ";
                  cityStateZip += selectedLocation.location.postcode;
                }

                if (cityStateZip) {
                  addressParts.push(cityStateZip);
                }

                // Add country
                if (selectedLocation.location.country) {
                  addressParts.push(selectedLocation.location.country);
                }

                if (addressParts.length > 0) {
                  formattedAddress = addressParts.join(", ");
                }
              }
            }
          }

          // Combine location name and address for the description
          const fullLocationString = formattedAddress
            ? `${selectedLocationName} (${formattedAddress})`
            : selectedLocationName;

          const formData = {
            details: [
              {
                leadDetails: {
                  name: name,
                  email: email,
                  phone: phone,
                },
              },
            ],
            organizationProfile: organizationProfileId,
            issueTemplateId: issueTemplateId,
            actionActivityDetails: {
              title: `Organization visit - ${name}`,
              description: `Organization visit generated by chatbot for ${name}`,
              startDate: startDate.toISOString(),
              endDate: endDate.toISOString(),
              location:
                organizationLocations.find((loc) => loc._id === locationId) ||
                null,
            },
            chatbotId: chatbotId,
          };

          const res = await fetch(
            `${serverUrl}api/issue/create/multiple-with-lead`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          if (res.ok) {
            messages.push({
              sender: "bot",
              text: "Thank you for scheduling an organization visit. Our team will contact you shortly to confirm the details.",
            });
          } else {
            messages.push({
              sender: "bot",
              text: "There was an error scheduling your organization visit. Please try again later.",
            });
          }
          appendNewMessages();
        } catch (error) {
          console.error("Error scheduling organization visit:", error);
          messages.push({
            sender: "bot",
            text: "There was an error scheduling your organization visit. Please try again later.",
          });
          appendNewMessages();
        } finally {
          submitButton.disabled = false;
          btnText.style.display = "inline";
          btnLoading.style.display = "none";
        }
      };
    </script>
  </body>
</html>
